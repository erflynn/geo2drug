---
title: "examine_hc_annot.Rmd"
author: "E Flynn"
date: "3/25/2019"
output: html_document
---

Load all the study info
- how many studies are there
- what were downloaded before?
- which have annotations
```{r}
# what is the list
hc_drug_org <- read.csv("data/hc_drug_org.csv")
human_drug <- filter(hc_drug_org, organism=="Homo sapiens")
head(human_drug)

# TODO - download the array express data
prev_labeled <- read.csv("data/expr_label_mat.csv")
prev_labeled <- rename(prev_labeled, "gsm"="X")

# which are in the list?
# ... huh, this is missing the GSE :,( --> slightly more complicated to figure out which we need... oops


hc_labeled <- read.csv("data/expr_label_mat_hc_drug.csv")
hc_labeled <- rename(hc_labeled, "gsm"="X")
ale_data <- read.csv("../../drug_expression/drug_labeling/ale_processing/ale_combined_data.csv")
comb_labels <- left_join(rbind(prev_labeled, hc_labeled), ale_data[,c("gsm", "gse", "gpl", "text_sex", "text_tissue_name", "cell_line")]) 
```


Put together the full dataframe
```{r}
comb_c_b <- read.csv("data/broad_creeds_annot_combined.csv")
head(comb_c_b)

### PROBLEM - need to map all the data to drugbank annotations (or other?)
comb_c_b2 <- read.delim("data/hc_combined_df_drugbank.txt")


# separate this out
comb_c_b2_ctl_df <- separate_rows(comb_c_b2, ctrl_ids, sep="\\|")
comb_c_b2_pert_df <- separate_rows(comb_c_b2, pert_ids, sep="\\|")
comb_c_b2_ctl_df <- rename(comb_c_b2_ctl_df, "gsm"="ctrl_ids")
comb_c_b2_pert_df <- rename(comb_c_b2_pert_df, "gsm"="pert_ids")
comb_c_b2_ctl_df$pert_ids <- NULL
comb_c_b2_pert_df$ctrl_ids <- NULL
comb_c_b2_ctl_df$pert_type <- "ctl"
comb_c_b2_pert_df$pert_type <- "pert"
comb_c_b2_sep <- rbind(comb_c_b2_ctl_df, comb_c_b2_pert_df)

# join together the data
comb_w_labels <- inner_join(comb_c_b2_sep, comb_labels, by="gsm")
tail(comb_w_labels)
comb_w_labels

```


Cell line breakdown
```{r}
cl_dat <- read.delim("data/rough_cl_mapping.txt")
cell_line_sex <- inner_join(comb_w_labels, cl_dat[,c("text_tissue_name", "sex")], by="text_tissue_name")
cell_line_sex$sex <- sapply(cell_line_sex$sex, tolower)
cell_line_sex <- rename(cell_line_sex, "cl_sex"="sex")
cell_line_sex$text_sex[cell_line_sex$text_sex=="F"] <- "female"
cell_line_sex$text_sex[cell_line_sex$text_sex=="M"] <- "male"

length(intersect(comb_w_labels$text_tissue_name, cl_dat$text_tissue_name))
setdiff(comb_w_labels$text_tissue_name, cl_dat$text_tissue_name)

# compute accuracies
table(cell_line_sex$text_sex==cell_line_sex$cl_sex) # filter
calcCLSexStats(table(cell_line_sex[,c("text_sex", "cl_sex")]))
table(cell_line_sex$massir_sex==cell_line_sex$cl_sex)
calcCLSexStats(table(cell_line_sex[,c("massir_sex", "cl_sex")]))

table(cell_line_sex$toker_sex==cell_line_sex$cl_sex)
calcCLSexStats(table(cell_line_sex[,c("toker_sex", "cl_sex")]))

table(cell_line_sex$rank_sex==cell_line_sex$cl_sex)
calcCLSexStats(table(cell_line_sex[,c("rank_sex", "cl_sex")]))

mismatched <- (cell_line_sex[cell_line_sex$rank_sex!=cell_line_sex$cl_sex,]) # 478
table(mismatched[,c("rank_sex", "toker_sex", "cl_sex", "massir_sex")])
dim(filter(mismatched, toker_sex==rank_sex | massir_sex==rank_sex)) # 255 - about half, probs not a significant portion
possible_error <- filter(mismatched, toker_sex==rank_sex | massir_sex==rank_sex)
likely_error <- filter(mismatched, toker_sex==rank_sex & massir_sex==rank_sex) # 108
unique(likely_error[,c("geo_id","text_tissue_name", "cl_sex", "rank_sex")])


calcCLSexStats <- function(tab){
  ncorrect <- tab["female", "female"] + tab["male", "male"]
  nincorrect <-  tab["male", "female"] + tab["female", "male"]
  return(list("correct"=ncorrect, "incorrect"=nincorrect))
}
methods <- c("text", "toker", "massir", "rank")
stat.df <- data.frame(do.call(rbind, lapply(methods, function(x) {
  tab <- table(cell_line_sex[,c(paste(x, "sex", sep="_"), "cl_sex")])
  res <- data.frame(calcCLSexStats(tab))
  res$method <- x
  return(res)
  })))

stat.df2 <- stat.df %>% mutate(labeled=correct+incorrect) %>% mutate(unlabeled=nrow(cell_line_sex)-labeled)

# MELT
require('reshape2')
# create a figure
melted.tab <- melt(stat.df2)
melted.tab2 <- filter(melted.tab, variable!="labeled")

# refactor
melted.tab2$method <- factor(melted.tab2$method, c("text", "toker", "massir", "rank"))
melted.tab2$variable <- factor(melted.tab2$variable, c("unlabeled", "incorrect", "correct"))

ggplot(melted.tab2, aes(x=method, y=value, fill=variable))+geom_bar(stat="identity")+ylab("Number of samples")+theme(text = element_text(size=20))+ ggtitle("Sex Labeling of Cell lines")


```

Subtract out the cell lines!
- has a cell line annotation or "cell line" in name
```{r}
not_cell <- filter(comb_w_labels, !text_tissue_name %in% cl_dat$text_tissue_name)
not_cell2 <- filter(not_cell, !str_detect( text_tissue_name, "cell line"))

# filter a couple manually
not_cell2 <- filter(not_cell2, !text_tissue_name %in%  c("LNCAP-C4-2B cell", "HBL-1 cell", "EAhy 926 cell"))

```

Summarize back to instance level
```{r}
count.per.study <- not_cell2 %>% group_by(id) %>% summarize(num_f=sum(rank_sex=="female"), num_m=sum(rank_sex=="male"), 
                                                            drug_name=paste(unique(drug_name), collapse="|" ), gse=paste(unique(geo_id), collapse="|"), 
                                                            dbID=paste(unique(dbID), collapse="|"), tissue=names(which.max(table(tissue))), 
                                                            text_tissue_name=paste(unique(text_tissue_name), collapse="|"))
count.per.study$study_type <- ifelse(count.per.study$num_f==0, "m", ifelse(count.per.study$num_m==0, "f", "both"))


# TISSUE BREAKDOWN
ggplot(count.per.study, aes(x=tissue, fill=tissue))+
  geom_histogram(stat="count")+xlab("Tissue breakdown")+ylab("Number of studies")+theme(text = element_text(size=20), axis.text.x = element_text(angle = 90, hjust = 1))+facet_grid(study_type ~ .)

count.per.study[count.per.study$tissue=="Prostate",] # two of these are BRAIN, for kidney many are actually BREAST

study_tab <-count.per.study[,c("gse", "study_type", "tissue")]
count_table <- table(study_tab[,c("study_type", "tissue")])
count_table <- count_table+1
chisq.p <- lapply(colnames(count_table), function(x)
       chisq.test(count_table[c("f", "m"),x])$p.value)
names(chisq.p) <- colnames(count_table)
chisq.p[chisq.p < 0.05/ncol(count_table)] # adipose,brain, breast, colon, kidney, liver 

```

Annotation breakdown --> replot:
- what are the most common drugs?
- ATC class breakdown (for CL labeled and not)
```{r}
drug_names <- separate_rows(count.per.study, dbID, sep="\\|")
drug_names2 <- unique(drug_names[,c("gse", "dbID","study_type")])

drug_names_annot <- inner_join(drug_names2, drugbank_df[,c("dbID", "name", "ATC")], by="dbID")
drug_names_annot2 <- drug_names_annot[!drug_names_annot$name %in% c("Dimethyl sulfoxide", "Ethanol", "Helium"),]
drug.counts <- table(as.factor(drug_names_annot2$name))
head(drug.counts[order(-drug.counts)], 30)
f.only.tab <- table(filter(drug_names_annot2, study_type=="f")$name)
m.only.tab <- table(filter(drug_names_annot2, study_type=="m")$name)
both.tab <- table(filter(drug_names_annot2, study_type=="both")$name)
head(data.frame(both.tab[order(-both.tab)]))
head(data.frame(f.only.tab[order(-f.only.tab)]))
head(data.frame(m.only.tab[order(-m.only.tab)]))

drug_names_annot2$class <- sapply(drug_names_annot2$ATC, function(x) ifelse(x=="", NA, substr(x, 1, 1)))

#table(is.na(atc_classes)) 
#atc_counts <- data.frame(table(atc_classes[!is.na(atc_classes)]))
#colnames(atc_counts) <- c("class", "count")
atc_names <- read.delim("data/ref_data/atc_classes.txt", header=FALSE)

colnames(atc_names) <- c("class", "descript")
#atc_info <- inner_join(atc_counts, atc_names)
atc_info2 <- inner_join(drug_names_annot2, atc_names)
atc_info2$descript <- factor(atc_info2$descript, atc_names$descript)
ggplot(filter(atc_info2, !is.na(study_type) & !is.na(descript) & class!="L"), aes(x=class, fill=descript))+geom_histogram(stat="count")+ggtitle("ATC breakdown")+facet_grid(study_type ~ .)+theme(text = element_text(size=20))

study_tab <-atc_info2[,c("gse", "study_type", "class")]
count_table <- table(study_tab[,c("study_type", "class")])
count_table <- count_table+1
chisq.p <- lapply(colnames(count_table), function(x)
       chisq.test(count_table[c("f", "m"),x])$p.value)
names(chisq.p) <- colnames(count_table)
chisq.p[chisq.p < 0.05/ncol(count_table)] # G, L

```


Look at a couple examples
```{r}
atc_info2[atc_info2$class=="N",]
drug_pert_manual[drug_pert_manual$geo_id=="GSE7036",] # these are NOT good

drug_names_annot[drug_names_annot$name=="Fluorouracil",]


head(count.per.study[count.per.study$tissue=="Liver",])

curated.set <- c(
"GSE38663"
,"GSE17183"
,"GSE11940"
,"GSE24187" )
curated_set_df <- count.per.study[count.per.study$gse %in% curated.set,]
curated_set_df2 <- unique(inner_join(curated_set_df[,c("id", "num_f", "num_m", "gse", "study_type", "dbID", "drug_name")], broad_mapped[,c("id", "pert_ids", "inst_info", "ctrl_ids", "ctl_label")], by="id"))
write.csv(curated_set_df2, file="data/selected_liver.csv", row.names=FALSE, quote=TRUE)


curated_all_sex_lab <- filter(comb_w_labels, geo_id %in% curated.set)
filter(curated_all_sex_lab, text_sex!="")  # <-- all of these match!
table(curated_all_sex_lab$text_sex) # ALMOST NONE

curated_all_sex_lab[(curated_all_sex_lab$toker_sex!=curated_all_sex_lab$rank_sex),] # only 4 disagree, 33 disagree for massiR
# - note: this is GPL570! - #

# we can't say that ours are better, tho they do have really good overall concordance, which is reassuring

# TODO - separate rows on dbID
```



